# Gemini API é…ç½®è©³è§£èˆ‡é »ç‡é™åˆ¶è§£æ±ºæ–¹æ¡ˆ (é‡å° Gemini 2.5 Flash/Pro)

é€™ä»½æ–‡ä»¶ç¸½çµäº†åœ¨é–‹ç™¼ç¤¾ç¾¤è‡ªå‹•ç™¼æ–‡ APP æ™‚ï¼Œé‡å° Google Gemini API (ç‰¹åˆ¥æ˜¯ 2.5 ç‰ˆæœ¬) çš„ä¸²æ¥å¯¦æˆ°ç¶“é©—ã€‚æ—¨åœ¨è§£æ±ºã€Œé »ç‡å¤ªé«˜ã€ã€ã€Œæ¨¡å‹æ‰¾ä¸åˆ°ã€ä»¥åŠå®‰å…¨æ€§æ””æˆªç­‰å¸¸è¦‹å•é¡Œï¼Œä¸¦æä¾›äº†ä¸€å¥—èˆ‡ AI å”ä½œæ¢ç´¢æ–°æŠ€è¡“çš„æ–¹æ³•è«–ã€‚

---

## 1. AI å”ä½œèˆ‡æ¨¡å‹é©—è­‰ SOP (The Verification Methodology)

é€™æ˜¯ä¸€å€‹ç‰¹åˆ¥é‡å°ã€Œå¦‚ä½•èˆ‡ AI å”ä½œå°‹æ‰¾æœ€æ–°æŠ€è¡“ã€çš„æ–¹æ³•è«–ã€‚ç•¶ AI çš„è¨“ç·´è³‡æ–™éæ™‚ï¼Œè€Œä½ æƒ³ç¢ºèªä¸–ç•Œä¸Šæ˜¯å¦æœ‰æ›´æ–°çš„ API (å¦‚ Gemini 3.0) æ™‚ï¼Œè«‹éµå¾ªæ­¤ SOPã€‚

### 1.1 æ ¸å¿ƒå•é¡Œ (The Core Problem)
**AI æ˜¯æ´»åœ¨éå»çš„ã€‚** å®ƒçš„çŸ¥è­˜æˆªæ­¢æ–¼è¨“ç·´ç•¶ä¸‹ã€‚å¦‚æœä½ å•å®ƒï¼šã€Œç¾åœ¨æœ‰ Gemini 2.5 å—ï¼Ÿã€å®ƒå¯èƒ½æœƒè‡ªä¿¡åœ°å‘Šè¨´ä½ ï¼šã€Œæ²’æœ‰ï¼Œæœ€æ–°çš„æ˜¯ 1.5ã€‚ã€(å› ç‚ºåœ¨å®ƒçš„è¨˜æ†¶è£¡ç¢ºå¯¦æ²’æœ‰)ã€‚

### 1.2 å”ä½œä¸‰å®ˆå‰‡ (The 3 Rules)

è‹¥è¦çªç ´é€™å€‹é™åˆ¶ï¼Œç²å–çœŸå¯¦ä¸–ç•Œçš„æœ€æ–°è³‡è¨Šï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå¼•å° AIï¼š

#### Rule 1: æ ¡æ­£æ™‚é–“èªçŸ¥ (Time Awareness)
*   **æŒ‡ä»¤ç¯„ä¾‹**: ã€Œç¾åœ¨ç³»çµ±æ™‚é–“æ˜¯ 2025 å¹´ 12 æœˆï¼Œè«‹æ„è­˜åˆ°ä½ çš„è¨“ç·´è³‡æ–™å¯èƒ½å·²ç¶“éæ™‚ã€‚ã€
*   **ç›®çš„**: è®“ AI é™ä½å°å…§å»ºçŸ¥è­˜çš„è‡ªä¿¡åº¦ï¼Œè½‰è€Œå°‹æ±‚å¤–éƒ¨é©—è­‰ã€‚

#### Rule 2: ç¦æ­¢ä¾è³´ã€Œå…§å»ºçŸ¥è­˜ã€ (Bypass Internal Knowledge)
*   **æŒ‡ä»¤ç¯„ä¾‹**: ã€Œä¸è¦å‘Šè¨´æˆ‘ä½ è¨˜æ†¶ä¸­æœ‰å“ªäº›æ¨¡å‹ï¼Œæˆ‘è¦ä½ ç›´æ¥å»æ¸¬è©¦ã€‚ã€
*   **ç›®çš„**: å¼·åˆ¶ AI åˆ‡æ›æ¨¡å¼ï¼Œå¾ã€Œå›ç­”å•é¡Œã€è½‰è®Šç‚ºã€ŒåŸ·è¡Œå·¥å…·ã€ã€‚

#### Rule 3: å¼·åˆ¶ã€Œå¯¦è­‰ä¸»ç¾©ã€ (Enforce Verification)
*   **æŒ‡ä»¤ç¯„ä¾‹**: ã€Œå¯«ä¸€å€‹è…³æœ¬ï¼Œå° API ç«¯é»é€²è¡Œçª®èˆ‰æ¸¬è©¦ (Brute-force)ï¼Œå˜—è©¦ `gemini-2.5-flash`, `gemini-3.0` ç­‰åç¨±ï¼Œä¸¦ä»¥ HTTP 200/404 ç‹€æ…‹ç¢¼ç‚ºæº–ã€‚ã€
*   **ç›®çš„**: é€™æ˜¯å”¯ä¸€èƒ½ç²å–çœŸç›¸çš„æ–¹æ³•ã€‚
    *   **HTTP 404** = çœŸä¸å­˜åœ¨ (æˆ–æ²’æ¬Šé™)ã€‚
    *   **HTTP 200/429** = çœŸå¯¦å­˜åœ¨ (å³ä½¿ AI è¦ºå¾—ä¸å­˜åœ¨)ã€‚

### 1.3 å¯¦æˆ°è…³æœ¬ç¯„ä¾‹ (verify-models.ts)

ä»¥ä¸‹æ˜¯ä¸€å€‹æ¨™æº–çš„ã€Œæ¢æ¸¬è…³æœ¬ã€ï¼Œä»¥å¾Œé‡åˆ°æ–°æ¨¡å‹ç™¼å¸ƒå‚³èæ™‚ï¼Œç›´æ¥è·‘é€™å€‹è…³æœ¬æœ€æº–ï¼š

```typescript
const CANDIDATES = [
    "gemini-2.5-flash", 
    "gemini-3.0-pro",
    "gemini-ultra-latest" // å¯ä»¥éš¨æ„çŒœæ¸¬
];

// ... (ä½¿ç”¨ fetch è¿´åœˆæ¸¬è©¦ä¸Šè¿°åå–®)
// å¦‚æœå›å‚³ 404 -> âŒ
// å¦‚æœå›å‚³ 200 æˆ– 429 -> âœ… (æ‰¾åˆ°äº†!)
```

---

## 2. æ¨¡å‹é¸æ“‡æ¼”é€²èˆ‡æ±ºç­–æ€è€ƒ (Case Study: å¾ 1.5 åˆ° 2.5 çš„å‡ç´šä¹‹è·¯)

åœ¨é–‹ç™¼æœ¬å°ˆæ¡ˆçš„éç¨‹ä¸­ï¼Œæˆ‘å€‘ç¶“æ­·äº†å¾ Gemini 1.5 åˆ° 2.0ï¼Œæœ€å¾Œå®šæ¡ˆæ–¼ 2.5 çš„éç¨‹ã€‚é€™æ®µç¶“æ­·æä¾›äº†ä¸€å€‹å¾ˆå¥½çš„æ€è€ƒæ¡†æ¶ï¼Œä¾›æœªä¾†é¸æ“‡æ¨¡å‹æ™‚åƒè€ƒã€‚

### 2.1 æ¼”é€²æ­·ç¨‹

1.  **Phase 1: èµ·æ­¥æ–¼ Gemini 1.5 (Pro/Flash)**
    *   **åŸå› **: é€™æ˜¯ç•¶æ™‚æ–‡ä»¶æœ€é½Šå…¨ã€æœ€ç©©å®šçš„ç‰ˆæœ¬ã€‚
    *   **é™åˆ¶**: éš¨è‘—å°ˆæ¡ˆæ¨é€²ï¼Œå°ä¸­æ–‡èªæ„ç†è§£èˆ‡ç”Ÿæˆé€Ÿåº¦æœ‰æ›´é«˜è¦æ±‚ï¼Œ1.5 é–‹å§‹é¡¯å¾—ç¨æ…¢ã€‚

2.  **Phase 2: å˜—è©¦ Gemini 2.0 Flash Exp**
    *   **å‹•æ©Ÿ**: è¿½æ±‚æ¥µè‡´çš„æ¨ç†é€Ÿåº¦ã€‚
    *   **é­é‡å•é¡Œ**: 
        *   `404 Not Found`: å¯¦é©—ç‰ˆæ¨¡å‹ (`-exp`) ç”Ÿå‘½é€±æœŸçŸ­ï¼Œç¶“å¸¸è¢«å®˜æ–¹ç„¡é è­¦ä¸‹æ¶æˆ–æ”¹åã€‚
        *   `406 Not Acceptable`: æ–°æ¨¡å‹çš„å®‰å…¨å¯©æŸ¥æ©Ÿåˆ¶è®Šå‹•ï¼Œå°è‡´èˆŠçš„ Prompt å®¹æ˜“è¢«æ””æˆªã€‚
    *   **å­¸ç¿’**: ä¸è¦éåº¦ä¾è³´å¸¶æœ‰ `exp` å¾Œç¶´çš„æ¨¡å‹æ–¼ç”Ÿç”¢ç’°å¢ƒã€‚

3.  **Phase 3: å®šæ¡ˆæ–¼ Gemini 2.5 (Flash/Pro)**
    *   **è½‰æŠ˜é»**: ç¶“é `verify-new-models.ts` è…³æœ¬å¯¦æ¸¬ï¼Œç¢ºèª **Gemini 2.5** å·²é€²å…¥ç©©å®šå¯ç”¨éšæ®µ (`gemini-2.5-flash` / `gemini-2.5-pro`)ã€‚
    *   **æˆæœ**: 
        *   **Flash**: ç”¨æ–¼è™•ç†å¤§é‡å…¬é–‹æ•¸æ“šæŠ“å–ï¼Œé€Ÿåº¦æå‡é¡¯è‘—ã€‚
        *   **Pro**: ç”¨æ–¼ç­–ç•¥ç”Ÿæˆï¼Œé‚è¼¯æ·±åº¦è¶…è¶Š 1.5 Proã€‚

### 2.2 å¦‚ä½•åšæ¨¡å‹é¸æ“‡æ±ºç­–ï¼Ÿ(æ€è€ƒæ¡†æ¶)

ç•¶æ‚¨é¢è‡¨ã€Œè©²ç”¨å“ªå€‹æ¨¡å‹ï¼Ÿã€çš„é¸æ“‡æ™‚ï¼Œè«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿæ€è€ƒï¼š

1.  **é¦–è¦åŸå‰‡ï¼šé©—è­‰è€ŒéçŒœæ¸¬**
    *   ä¸è¦åªçœ‹æ–°èç¨¿ (News) èªªå‡ºäº† 3.0 å°±ç›´æ¥æ”¹ä»£ç¢¼ã€‚
    *   **Action**: å‹™å¿…å…ˆå¯«ä¸€å€‹ç°¡å–®çš„ `verify.ts` è…³æœ¬ï¼Œç›´æ¥å° API ç™¼é€è«‹æ±‚ï¼Œç¢ºèªè©²æ¨¡å‹ ID (`gemini-3.0`) åœ¨æ‚¨çš„ API Key æ¬Šé™ä¸‹æ˜¯å¦å›å‚³ `200 OK`ã€‚

2.  **å€åˆ†ã€Œå¯¦é©—ã€èˆ‡ã€Œç©©å®šã€**
    *   é–‹ç™¼éšæ®µå¯ä»¥ç”¨ `exp` (å¦‚ `gemini-2.0-flash-exp`) åšé®®ã€‚
    *   **ç”Ÿç”¢ç’°å¢ƒ (Production)** å¿…é ˆä½¿ç”¨ç©©å®šç‰ˆ (ç„¡ `exp` å¾Œç¶´ï¼Œå¦‚ `gemini-2.5-flash`)ï¼Œä»¥å…æœå‹™çªç„¶ä¸­æ–·ã€‚

3.  **ä¾åŠŸèƒ½åˆ†æµ (The Right Tool for the Joob)**
    *   **éœ€è¦ç§’å›çš„** (Chatbot, æ•¸æ“šæ¸…æ´—) â¡ï¸ é¸ **Flash**ã€‚
    *   **éœ€è¦æƒ³å¾ˆä¹…çš„** (å¯«æ–‡ç« , ç­–ç•¥è¦åŠƒ) â¡ï¸ é¸ **Pro**ã€‚

---

## 3. æ­£ç¢ºçš„ API è«‹æ±‚é…ç½® (Gemini 2.5)

Gemini 2.5 ä¸–ä»£å¼•å…¥äº†æ›´å¼·å¤§çš„æ¨¡å‹ï¼Œä½†ä¹Ÿå°è«‹æ±‚æ ¼å¼æœ‰æ›´åš´æ ¼çš„è¦æ±‚ã€‚ä»¥ä¸‹æ˜¯æ¨™æº–çš„ Raw API è«‹æ±‚é…ç½®ã€‚

### 3.1 ç«¯é» (Endpoint) èˆ‡æ¨¡å‹åç¨±

è«‹æ³¨æ„ï¼ŒGemini 2.5 ç›®å‰ (2025/12) åŒ…å«ä»¥ä¸‹ç©©å®šç‰ˆæœ¬ï¼š

*   **`gemini-2.5-flash`**: 
    *   **ç‰¹é»**: é€Ÿåº¦æ¥µå¿«ã€æˆæœ¬æœ€ä½ï¼Œé©åˆå¤§é‡æ•¸æ“šåˆ†æã€ç°¡å–®æ–‡æœ¬ç”Ÿæˆã€‚
    *   **é©ç”¨å ´æ™¯**: Log åˆ†æã€ç¤¾ç¾¤è²¼æ–‡åˆç¨¿ã€è³‡æ–™æå–ã€‚
*   **`gemini-2.5-pro`**:
    *   **ç‰¹é»**: é‚è¼¯æ¨ç†å¼·ã€å‰µæ„å“è³ªé«˜ï¼Œä½†é€Ÿåº¦ç¨æ…¢ï¼Œä¸”é »ç‡é™åˆ¶è¼ƒåš´æ ¼ã€‚
    *   **é©ç”¨å ´æ™¯**: å“ç‰Œç­–ç•¥ç”Ÿæˆã€è¤‡é›œæ–‡æ¡ˆæ’°å¯«ã€æƒ…æ„Ÿåˆ†æã€‚

**è«‹æ±‚ URL æ ¼å¼**:
```
https://generativelanguage.googleapis.com/v1beta/models/{MODEL_NAME}:generateContent?key={API_KEY}
```

### 3.2 è«‹æ±‚æ¨™é ­ (Headers) èˆ‡æœ¬é«” (Body)

é€™éƒ¨åˆ†æœ€å®¹æ˜“å‡ºéŒ¯ï¼Œå‹™å¿…ç¢ºä¿ `Content-Type` æ­£ç¢ºã€‚

```javascript
const response = await fetch(
  `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json' // å¿…å¡«
    },
    body: JSON.stringify({
      contents: [{
        parts: [{
          text: "æ‚¨çš„ Prompt æç¤ºè©..."
        }]
      }],
      // å¦‚éœ€å¼·åˆ¶å›å‚³ JSON (Gemini 2.5 å¼·åŠ›æ¨è–¦)
      generationConfig: {
        responseMimeType: "application/json"
      }
    })
  }
);
```

---

## 4. é »ç‡é™åˆ¶ (Rate Limits) èˆ‡ 429 éŒ¯èª¤è§£æ±ºæ–¹æ¡ˆ

æ‚¨é‡åˆ°çš„ã€Œé »ç‡å¤ªé«˜ã€æˆ–ã€Œä¸€ç›´å‡ºç¾é‡è¤‡ã€çš„å•é¡Œï¼Œé€šå¸¸å°æ‡‰ HTTP ç‹€æ…‹ç¢¼ **`429 Too Many Requests`**ã€‚

Gemini çš„å…è²»å±¤ç´š (Free Tier) æœ‰åš´æ ¼çš„æ¯åˆ†é˜è«‹æ±‚æ•¸ (RPM) é™åˆ¶ã€‚å¦‚æœä¸è™•ç†ï¼Œç¨‹å¼å°±æœƒç›´æ¥å´©æ½°ã€‚

### 4.1 ç‚ºä»€éº¼æœƒç™¼ç”Ÿï¼Ÿ
1.  **ä¸¦ç™¼è«‹æ±‚éå¤š**: åŒæ™‚ç™¼é€ 5-10 å€‹ API è«‹æ±‚ (ä¾‹å¦‚ä¸€æ¬¡ç”Ÿæˆ 12 ç¯‡è²¼æ–‡)ã€‚
2.  **çŸ­æ™‚é–“å¯†é›†è«‹æ±‚**: è¿´åœˆ (Loop) ä¸­æ²’æœ‰æš«åœ (Sleep)ã€‚

### 4.2 é»ƒé‡‘è§£æ±ºæ–¹æ¡ˆï¼šæŒ‡æ•¸é€€é¿ (Exponential Backoff)

ä¸è¦åªæ˜¯é‡è©¦ï¼Œè¦ã€Œè¶Šç­‰è¶Šä¹…ã€ã€‚è«‹å°‡æ­¤é‚è¼¯å°è£åˆ°æ‚¨çš„ API è«‹æ±‚å‡½æ•¸ä¸­ï¼š

```typescript
const wait = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

async function fetchWithRetry(url: string, options: any, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url, options);
      
      // âœ… æˆåŠŸç›´æ¥å›å‚³
      if (response.ok) return response;
      
      // âš ï¸ é‡åˆ° 429 (Too Many Requests) æˆ– 503 (Server Overload)
      if (response.status === 429 || response.status === 503) {
        // è¨ˆç®—ç­‰å¾…æ™‚é–“: 2ç§’ -> 4ç§’ -> 8ç§’...
        const delay = 2000 * Math.pow(2, i);
        console.warn(`[API é™æµ] è«‹æ±‚éæ–¼é »ç¹ï¼Œç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
        await wait(delay);
        continue; // é€²å…¥ä¸‹ä¸€æ¬¡è¿´åœˆé‡è©¦
      }
      
      // å…¶ä»–éŒ¯èª¤ (å¦‚ 400 Bad Request) ç›´æ¥æ‹‹å‡ºï¼Œå› ç‚ºé‡è©¦ä¹Ÿæ²’ç”¨
      throw new Error(`API Error: ${response.status}`);
      
    } catch (error) {
      if (i === retries - 1) throw error; // æœ€å¾Œä¸€æ¬¡é‡è©¦å¤±æ•—ï¼Œæ‰æ‹‹å‡ºéŒ¯èª¤
    }
  }
}
```

---

## 5. å¸¸è¦‹éŒ¯èª¤ä»£ç¢¼è§£å¯† (Error Codes Decoder)

é™¤äº†è§£æ±º 429ï¼Œæ‚¨å¯èƒ½é‚„æœƒé‡åˆ°ä»¥ä¸‹ç‹€æ³ï¼š

### ğŸš¨ 406 Not Acceptable / 400 Bad Request (å®‰å…¨æ€§æ””æˆª)
*   **ç¾è±¡**: è«‹æ±‚æ²’æœ‰éŒ¯èª¤ï¼Œä½†å›å‚³å…§å®¹ç‚ºç©ºï¼Œæˆ–è¢«æ¨™è¨˜ç‚º `finishReason: SAFETY`ã€‚
*   **åŸå› **: ç”Ÿæˆå…§å®¹è§¸ç™¼äº† Google çš„å®‰å…¨éæ¿¾å™¨ (ä»‡æ¨è¨€è«–ã€æš´åŠ›ã€è‰²æƒ…ç­‰)ã€‚
*   **Gemini 2.5 çš„å·®ç•°**: 2.5 ç‰ˆçš„å®‰å…¨å¯©æŸ¥æ¯” 1.5 æ›´æ•æ„Ÿã€‚
*   **è§£æ³•**: åœ¨ `safetySettings` ä¸­èª¿ä½æ•æ„Ÿåº¦ã€‚

```javascript
body: JSON.stringify({
  // ... contents ...
  safetySettings: [
    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
  ]
})
```

### ğŸš¨ 404 Not Found (æ¨¡å‹æœªæ‰¾åˆ°)
*   **ç¾è±¡**: `models/gemini-2.0-flash-exp is not found`ã€‚
*   **åŸå› **: Google é »ç¹æ›´æ–°æ¨¡å‹åç¨±ï¼ŒèˆŠçš„å¯¦é©—ç‰ˆ (`-exp`) ç¶“å¸¸è¢«ç„¡é è­¦ä¸‹æ¶ã€‚
*   **è§£æ³•**: 
    1.  **é–å®šç©©å®šç‰ˆ**: å„ªå…ˆä½¿ç”¨ `gemini-1.5-flash` æˆ– `gemini-2.5-flash` (ä¸å¸¶å¾Œç¶´)ã€‚
    2.  **å®šæœŸæª¢æŸ¥åˆ—è¡¨**: é€é `GET https://generativelanguage.googleapis.com/v1beta/models?key={API_KEY}` ç¢ºèªç•¶å‰å¯ç”¨æ¨¡å‹ã€‚

---

## 6. æœ€ä½³å¯¦è¸ Check List (é–‹ç™¼å‰è‡ªæˆ‘æª¢æŸ¥)

- [ ] **API Key ä¿è­·**: 
    - âŒ çµ•å°ä¸è¦ç›´æ¥å¯«æ­»åœ¨ç¨‹å¼ç¢¼ä¸­ (`const API_KEY = "AIza..."`)ã€‚
    - âœ… å¯«åœ¨ `.env` æª”ï¼Œä¸¦ç”¨ `.gitignore` æ’é™¤ã€‚
- [ ] **éŒ¯èª¤è™•ç† (Try-Catch)**: æ‰€æœ‰çš„ API è«‹æ±‚éƒ½å¿…é ˆåŒ…åœ¨ `try...catch` å€å¡Šä¸­ï¼Œé¿å…ç¶²è·¯æ–·ç·šå°è‡´ APP ç™½å±ã€‚
- [ ] **JSON è§£æä¿è­·**: AI æœ‰æ™‚æœƒå›å‚³ä¸æ¨™æº–çš„ JSON (ä¾‹å¦‚å¿˜è¨˜åŠ  `}`). å‹™å¿…ä½¿ç”¨ `try { JSON.parse() } catch` ä¾†æ¥ä½è§£æéŒ¯èª¤ã€‚
- [ ] **Loading ç‹€æ…‹**: AI ç”Ÿæˆé€šå¸¸éœ€è¦ 3-10 ç§’ï¼Œå‰ç«¯ä»‹é¢å‹™å¿…é¡¯ç¤º Loading Spinnerï¼Œé¿å…ç”¨æˆ¶é‡è¤‡é»æ“Šã€‚

---

> **ç¸½çµ**: 
> é¢å° Gemini APIï¼Œæœ€ç©©å¥çš„ç­–ç•¥æ˜¯ **ã€Œé¸å°æ¨¡å‹ (2.5-flash)ã€** + **ã€Œå¯¦ä½œ retry æ©Ÿåˆ¶ã€** + **ã€Œåšå¥½æœ€å£æ‰“ç®— (Mock Data Fallback)ã€**ã€‚
