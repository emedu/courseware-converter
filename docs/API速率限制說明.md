# 🚨 API 速率限制問題解決方案

## 問題說明

如果您遇到以下錯誤訊息：
```
⚠️ 請求太頻繁，請等待 30 秒後再試。
💡 提示：Gemini 免費版每分鐘只能發送 15 次請求。
```

這是因為 Google Gemini API 的**免費版**有嚴格的速率限制。

---

## 📊 Gemini API 免費版限制

| 限制類型 | 免費版 | 付費版 |
|---------|--------|--------|
| **每分鐘請求數 (RPM)** | 15 次 | 360+ 次 |
| **每天請求數** | 1,500 次 | 無限制 |
| **每次請求 Token** | 最多 32,000 | 最多 128,000+ |

---

## ✅ 已實作的解決方案

本專案**已經實作**了完整的速率限制處理機制：

### 1️⃣ **自動請求延遲（節流）**
- 每次請求之間**自動等待 4 秒**
- 確保不超過每分鐘 15 次的限制

### 2️⃣ **指數退避重試機制**
- 收到 429 錯誤時**自動重試**（最多 3 次）
- 重試等待時間逐次增加：5秒 → 10秒 → 20秒

### 3️⃣ **詳細的錯誤訊息**
- 清楚說明問題原因
- 提供解決建議

---

## 🛠️ 自訂速率限制設定

您可以在 `.env` 檔案中調整速率限制設定：

```env
# Gemini API 速率限制設定
GEMINI_REQUEST_DELAY=4000          # 請求間隔（毫秒）
GEMINI_MAX_RETRIES=3                # 最大重試次數
GEMINI_RETRY_DELAY=5000             # 重試基礎延遲（毫秒）
```

### 建議設定

**免費版用戶（15 RPM）：**
```env
GEMINI_REQUEST_DELAY=4000    # 4秒間隔，確保安全
GEMINI_MAX_RETRIES=3
GEMINI_RETRY_DELAY=5000
```

**付費版用戶（360 RPM）：**
```env
GEMINI_REQUEST_DELAY=200     # 0.2秒間隔即可
GEMINI_MAX_RETRIES=5
GEMINI_RETRY_DELAY=2000
```

**保守設定（更穩定）：**
```env
GEMINI_REQUEST_DELAY=5000    # 5秒間隔
GEMINI_MAX_RETRIES=5
GEMINI_RETRY_DELAY=10000
```

---

## 🔍 運作原理

### 請求流程示意

```
用戶上傳文件
    ↓
前端傳送到後端
    ↓
後端：檢查距離上次請求是否已超過 4 秒
    ↓ 
    ├─ 是 → 立即發送請求
    └─ 否 → 等待剩餘時間 → 發送請求
    ↓
收到 Google Gemini 回應
    ↓
    ├─ 成功 (200) → 返回結果
    ├─ 速率限制 (429) → 等待 5秒 → 重試
    └─ 其他錯誤 → 返回錯誤訊息
```

### 日誌輸出範例

```
⏱️  速率限制：等待 2 秒後繼續...
📡 正在呼叫 Gemini API... (嘗試 1/4)
✅ Gemini API 呼叫成功
```

或遇到速率限制時：
```
📡 正在呼叫 Gemini API... (嘗試 1/4)
⚠️  收到速率限制 (429)，將在 5 秒後重試...
📡 正在呼叫 Gemini API... (嘗試 2/4)
✅ Gemini API 呼叫成功
```

---

## 💡 使用建議

### 一般使用
1. **小文件（< 2000 字）**
   - 通常會發送 2 次請求（分析 + 結構化）
   - 總耗時約：8-10 秒

2. **中型文件（2000-5000 字）**
   - 可能需要 2-4 次請求
   - 總耗時約：15-20 秒

3. **大型文件（> 5000 字）**
   - 建議先分段處理
   - 或考慮升級到付費版

### 避免問題
- ✅ **一次處理一個文件**
- ✅ **等待分析完成再上傳下一個**
- ❌ 不要連續快速上傳多個文件
- ❌ 不要在短時間內重複點擊「AI 分析」

---

## 🚀 升級到付費版

如需處理大量文件或提升速度，可考慮升級：

### 升級步驟
1. 訪問 [Google Cloud Console](https://console.cloud.google.com/)
2. 啟用計費帳戶
3. 在 [Google AI Studio](https://aistudio.google.com/) 中綁定計費專案
4. 使用付費專案的 API Key

### 付費版優勢
- ✅ 每分鐘 360 次請求（24 倍提升）
- ✅ 無每日請求限制
- ✅ 更高的 Token 限制
- ✅ 優先處理

### 費用參考
- Gemini 2.0 Flash: 約 $0.075 / 1M tokens（輸入）
- 一般教材文件：約 1,000-5,000 tokens
- 估算成本極低（通常 < $0.01 每份文件）

---

## ❓ 常見問題

### Q1: 為什麼要等 4 秒？
**A:** 免費版每分鐘只能 15 次請求，平均每次需間隔 4 秒才安全。

### Q2: 可以改成 1 秒嗎？
**A:** 可以，但風險很高。建議免費版至少保持 3 秒以上。

### Q3: 已經等了 4 秒，還是說太頻繁？
**A:** 可能是之前的請求累積導致。系統會自動重試，請耐心等待。

### Q4: 付費版需要改設定嗎？
**A:** 是的，付費版可以調整為：
```env
GEMINI_REQUEST_DELAY=200    # 0.2秒即可
```

### Q5: 重試機制會增加費用嗎？
**A:** 
- **免費版**: 不會，配額是固定的
- **付費版**: 會，每次重試都計費（但通常不會重試）

---

## 📊 監控使用量

### 查看 API 使用統計
1. 訪問 [Google AI Studio](https://aistudio.google.com/)
2. 點擊右上角個人資料
3. 查看「Usage」或「配額」

### 後端日誌
啟動伺服器時會顯示：
```bash
📡 正在呼叫 Gemini API...
⏱️  速率限制：等待 X 秒後繼續...
✅ Gemini API 呼叫成功
```

---

## 📞 需要協助？

如果持續遇到問題：

1. **檢查清單**
   - [ ] `.env` 中的 `GEMINI_API_KEY` 是否正確
   - [ ] 是否一次上傳太多文件
   - [ ] 網路連線是否穩定
   - [ ] API 配額是否已用盡

2. **查看日誌**
   - 啟動伺服器的終端視窗
   - 查看詳細錯誤訊息

3. **聯絡支援**
   - 提供錯誤訊息截圖
   - 說明使用情境

---

**最後更新**: 2025-12-07  
**版本**: 1.1.1
