# AI 教材轉換器 - 排版優化專案記錄

**專案日期**: 2025-12-24  
**最後更新**: 2025-12-24 17:33  
**GitHub Commit**: `85d3cf8` (2025-12-24 16:35)

---

## 📋 專案概述

### 目標
將 Word 文件教材轉換為精美排版的 A4 預覽頁面,100% 保留原始內容,可直接列印或輸出 PDF。

### 核心原則
1. **內容完整性 > 一切** - 絕對不可刪減、摘要、省略
2. **排版美觀 = 核心價值** - 專業教材級別
3. **自動化處理 = 省時省力** - 智能識別結構

### 用戶需求確認 (Q1-Q7)
- **Q1 排版風格**: C - 專業培訓手冊風格
- **Q2 顏色使用**: B - 使用主題色(藍色標題)
- **Q3 章節分頁**: A - 每章從新頁開始
- **Q4 圖片處理**: A+B - 顯示文字說明 + 預留空白區域
- **Q5 表格識別**: A - 必須100%正確識別並美化
- **Q6 處理方式**: 離線模式(已實現)
- **Q7 痛點優先級**: 排版美觀(1) > 表格顯示(2) > 處理速度(5) > 內容刪減(4) > 目錄格式(3)

---

## ✅ 已完成工作

### 階段 1: 基礎排版樣式系統 (已完成)

#### 1.1 新增 CSS 樣式系統 (+175 行)

**檔案**: `app/css/styles.css`

##### 主要樣式類別

**標題系統**:
```css
.content-title        /* 主標題: 32px, 粗體, 置中, 底部邊框 */
.content-chapter      /* 章節標題: 24px, 左側6px藍色邊條, 漸層背景, 強制換頁 */
.content-section      /* 小節標題: 18px, 左側4px邊條, 淺色背景 */
```

**目錄系統**:
```css
.content-toc          /* 目錄容器: 淺灰背景, 圓角邊框 */
.content-toc h2       /* 目錄標題: 置中, 底部邊框 */
.content-toc p        /* 目錄項目: flexbox + ::after 偽元素實現點點對齊 */
```

**特殊內容區塊**:
```css
.content-keypoint     /* 重點提示: 黃色背景, 橙色左邊框 */
.content-definition   /* 術語定義: 淺藍背景, 藍色左邊框 */
.content-warning      /* 警告提示: 淺紅背景, 紅色左邊框 */
```

**圖片系統**:
```css
.content-image                /* 圖片容器: 置中, 圓角, 陰影 */
.content-image-placeholder    /* 圖片佔位符: 虛線邊框, 漸層背景, 相機圖示, 200px高度 */
```

**表格系統**:
```css
.content-table        /* 表格美化: 圓角, 陰影, 斑馬紋, hover 效果 */
```

**其他元素**:
```css
.content-paragraph    /* 段落文字: 行距2.0, 適當間距 */
.content-list         /* 列表樣式 */
.page-break           /* 分頁符號: 列印時強制換頁 */
```

#### 1.2 前端渲染邏輯優化

**檔案**: `app/js/main.js`

**修改 1: 目錄渲染優化** (行 415-426)
```javascript
// 改進前
html += `<p>${text} ...... ${pageNum}</p>`;

// 改進後 - 使用 flexbox 佈局
html += `<p><span>${text}</span><span>${pageNum}</span></p>`;
```
**效果**: 點點自動填充中間空白,頁碼靠右對齊

**修改 2: 圖片佔位符優化** (行 455-468)
```javascript
// A+B 方案實現
html += `<div class="content-image-placeholder">
  <p style="font-size: 48px;">📷</p>
  <p><strong>[建議插入圖片]</strong></p>
  <p>${description}</p>
</div>`;
```
**效果**: 顯示大圖示 + 文字說明 + 預留200px空白區域

#### 1.3 GitHub 提交記錄

**Commit**: `85d3cf8`  
**時間**: 2025-12-24 16:35:42  
**訊息**: feat: 新增專業培訓手冊排版樣式系統

**變更統計**:
- `app/css/styles.css`: +175 行
- `app/js/main.js`: 2 處修改
- 總計: 2 files changed, 183 insertions(+), 143 deletions(-)

---

## 🧪 測試驗證結果

### Demo 模式測試 (✅ 通過)

**測試環境**: `http://localhost:3000`  
**測試資料**: 粉刺管理師培訓教材 (Demo)

**測試結果**:
- ✅ 標題與章節樣式: 藍色大字體, 左側厚實邊條
- ✅ 目錄格式: 虛線導引, 頁碼對齊, 互動式連結
- ✅ 圖片預留位: 虛線框, 相機圖示, 描述文字
- ✅ 重點提示方框: 彩色背景, 左側邊條
- ✅ 分頁邏輯: 章節間有明顯視覺區分
- ✅ 控制台: 無 JavaScript 錯誤
- ✅ 功能測試: 頁碼計算、PDF 下載正常

**測試截圖**: 已保存在 artifacts 目錄

### 實際檔案測試 (❌ 發現問題)

**測試方式 1**: 上傳 PDF 檔案
- ❌ 解析後變成純文字
- ❌ 無法識別結構

**測試方式 2**: 直接貼上 Word 內容到 textarea
- ✅ 內容完整保留
- ✅ 基本樣式有套用
- ❌ 發現多個問題 (詳見下方)

---

## ❌ 實際測試發現的問題

### 問題 1: 多層級標題無法識別

**現象**:
- `第一章` (應該是大標題 24px)
- `1.` (應該是中標題 18px)
- `1.1` (應該是小標題 16px)
- `1.1.1` (應該是更小標題 15px)

**實際結果**: 所有標題看起來都一樣大,沒有層級差異

**原因**: 離線解析引擎只能識別 `\d+\.` (如 `1.`, `2.`),無法識別 `\d+\.\d+` (如 `1.1`, `1.2`)

### 問題 2: 表格沒有渲染

**現象**: Word 中的表格沒有正確顯示成表格

**原因**: 
- 離線引擎只能識別 Markdown 表格 (`| 欄位 |`)
- 無法識別 Tab 分隔的表格 (Word 複製過來的格式)

### 問題 3: 沒有頁碼

**現象**:
- 目錄沒有頁碼
- 頁尾沒有頁碼

**原因**: 頁碼計算功能可能沒有正確觸發

### 問題 4: 沒有圖片預留位置

**現象**: 缺少智能圖片佔位符插入

**原因**: 離線引擎沒有圖片建議邏輯

---

## 🔍 問題根本原因分析

### 核心問題: 離線解析引擎識別規則太弱

**當前識別規則** (`app/js/aiService.js` 的 `parseContentLocally()`)

```javascript
const patterns = {
    chapter: /^(第[0-9一二三四五六七八九十]+[章節]|Chapter\s+\d+)/i,
    section: /^(\d+\.|[一二三四五六七八九十]、)/,
    table: /^\|(.+)\|$/,  // Markdown 表格
    keypoint: /^\[建議[：:]\s*重點提示\]/,
    definition: /^\[建議[：:]\s*定義\]/,
    image: /^\[建議[：:]\s*插入?圖片[：:](.+)\]/,
};
```

**問題分析**:

1. **多層級標題無法識別**
   - ✅ 可識別: `1.`, `2.`, `3.` (一級小節)
   - ❌ 無法識別: `1.1`, `1.2`, `2.1` (二級小節)
   - ❌ 無法識別: `1.1.1`, `1.2.1` (三級小節)

2. **所有識別到的標題用同一個樣式**
   - `第一章` → `.content-chapter` (24px, 粗邊條)
   - `1.` → `.content-section` (18px, 細邊條)
   - `1.1` → **沒有對應樣式!** 被當成普通段落

3. **表格識別限制**
   - 只能識別: `| 欄位1 | 欄位2 |` (Markdown)
   - 無法識別: `欄位1\t欄位2` (Tab 分隔)

4. **沒有圖片建議邏輯**
   - 離線引擎不會主動建議插入圖片
   - 只有 AI 模式才會建議

---

## 💡 解決方案討論

### 方案 A: 增強離線解析引擎 ⭐ (已選擇)

**優點**:
- 符合核心需求: 自動化
- 不依賴 API Key
- 一次修改,永久受益

**需要修改**:
1. 增加多層級標題識別規則
2. 新增對應的 CSS 樣式
3. 改進表格識別
4. 修復頁碼計算
5. 增加圖片佔位符邏輯

### 方案 B: 混合模式 (AI + 離線)

**優點**: AI 能更準確識別結構和圖片位置  
**缺點**: 需要 API Key,用戶目前有限制

### 方案 C: 用戶手動標記

**優點**: 最簡單,不需修改程式碼  
**缺點**: 需要用戶手動編輯,不夠自動化

---

## 🎯 實施計畫 (方案 A)

### 階段 1: 核心功能修復 (必須)

#### 1.1 多層級標題識別

**新增識別規則**:
```javascript
// 在 aiService.js 的 parseContentLocally() 中新增
const patterns = {
    chapter: /^(第[0-9一二三四五六七八九十]+[章節]|Chapter\s+\d+)/i,
    section: /^(\d+\.)\s/,                    // 1. 2. 3.
    subsection: /^(\d+\.\d+)\s/,              // 1.1, 1.2, 2.1
    subsubsection: /^(\d+\.\d+\.\d+)\s/,      // 1.1.1, 1.2.1
    // ...
};
```

**識別優先順序**: 從最具體到最一般
1. `subsubsection` (1.1.1)
2. `subsection` (1.1)
3. `section` (1.)
4. `chapter` (第一章)

#### 1.2 新增 CSS 樣式

**新增樣式類別**:
```css
/* 二級小節標題 (1.1) */
.content-subsection {
    font-size: 16px;
    font-weight: 600;
    margin: 24px 0 12px 0;
    padding: 8px 0 8px 8px;
    border-left: 3px solid var(--primary-color);
    background: rgba(37, 99, 235, 0.02);
    line-height: 1.6;
}

/* 三級小節標題 (1.1.1) */
.content-subsubsection {
    font-size: 15px;
    font-weight: 600;
    margin: 20px 0 10px 0;
    padding: 6px 0 6px 6px;
    border-left: 2px solid var(--primary-color);
    background: rgba(37, 99, 235, 0.01);
    line-height: 1.6;
}
```

**視覺層次**:
- 第一章: 24px, 6px 邊條, 深色背景
- 1.: 18px, 4px 邊條, 中等背景
- 1.1: 16px, 3px 邊條, 淺色背景
- 1.1.1: 15px, 2px 邊條, 極淺背景

#### 1.3 修復頁碼計算

**檢查項目**:
1. `calculatePageNumbers()` 函數是否正確觸發
2. 頁碼計算邏輯是否正確
3. 目錄頁碼是否正確更新
4. 頁尾頁碼是否顯示

#### 1.4 改進表格識別

**新增 Tab 分隔表格識別**:
```javascript
// 識別 Tab 分隔的表格
function parseTabSeparatedTable(lines) {
    // 檢查是否為 Tab 分隔
    if (lines[0].includes('\t')) {
        const headers = lines[0].split('\t');
        const rows = lines.slice(1).map(line => line.split('\t'));
        return { headers, rows };
    }
    return null;
}
```

### 階段 2: 圖片處理

#### 方案選擇: 關鍵字匹配 + 手動標記 (混合)

**方案 1: 關鍵字自動匹配**
```javascript
// 遇到以下關鍵字自動插入圖片佔位符
const imageKeywords = [
    '結構', '構造', '組成',
    '流程', '步驟', '操作',
    '示意圖', '解剖圖', '結構圖'
];
```

**方案 2: 手動標記**
- 用戶可在 textarea 手動加入: `[圖片：皮膚三層結構圖]`
- 系統自動識別並渲染為佔位符

**優點**: 
- 大部分情況自動處理 (省時間)
- 需要精確時可手動調整 (保證準確)

---

## 📝 下次討論待確認事項

### 1. 階段 1 修改優先順序
- [ ] 確認多層級標題識別的優先順序
- [ ] 確認 CSS 樣式的層次設計 (字體大小、邊條粗細)
- [ ] 確認頁碼計算的修復方式
- [ ] 確認表格識別的改進方式

### 2. 圖片處理方案
- [ ] 確認採用哪種方案 (關鍵字/手動/混合)
- [ ] 如果採用關鍵字,確認要識別哪些關鍵字
- [ ] 確認圖片佔位符的顯示方式

### 3. 其他細節
- [ ] 是否需要支援更多標題格式?
- [ ] 是否需要支援其他特殊元素?
- [ ] 測試用的實際檔案格式確認

---

## 📊 專案狀態

### 當前狀態
- ✅ 基礎排版樣式系統: 已完成
- ✅ Demo 模式測試: 通過
- ✅ GitHub 同步: 已完成 (Commit `85d3cf8`)
- ⏸️ 實際檔案支援: 待改進

### 待處理項目
1. 多層級標題識別 (1.1, 1.2, 1.1.1)
2. 標題層級樣式差異化
3. 頁碼計算與顯示
4. 表格識別改進 (Tab 分隔格式)
5. 圖片佔位符智能插入

### 下一步
等待用戶確認改進方案後開始實施修改

---

## 📚 相關文件

### 專案檔案
- **主程式**: `app/js/main.js`
- **AI 服務**: `app/js/aiService.js`
- **樣式表**: `app/css/styles.css`
- **HTML**: `app/index.html`

### 文件記錄
- **本文件**: `docs/排版優化專案記錄_2025-12-24.md`
- **任務追蹤**: Artifact `task.md`
- **完成報告**: Artifact `walkthrough.md`
- **驗證報告**: Artifact `verification_report.md`
- **討論記錄**: Artifact `discussion_next_steps.md`

### GitHub
- **倉庫**: https://github.com/emedu/courseware-converter
- **最新 Commit**: `85d3cf8` (2025-12-24 16:35)
- **分支**: `master`

### 測試
- **測試網址**: http://localhost:3000
- **Demo 模式**: 點擊 "🚀 載入演示模式 (Demo)"

---

## 🔄 版本歷史

### v1.0 - 基礎排版系統 (2025-12-24)
- ✅ 新增完整 CSS 樣式系統
- ✅ 實現專業培訓手冊風格
- ✅ 支援 Demo 模式
- ✅ 通過功能測試

### v1.1 - 實際檔案支援 (計畫中)
- [ ] 多層級標題識別
- [ ] 表格識別改進
- [ ] 頁碼計算修復
- [ ] 圖片佔位符智能插入

---

**文件結束**

*本文件記錄了 AI 教材轉換器排版優化專案的完整歷程,包含已完成工作、測試結果、發現的問題、解決方案討論和實施計畫。*
